// Generated by CoffeeScript 1.6.2
(function() {
  define(['jquery', 'jqm', 'backbone', 'underscore', 'marionette', 'Meshable', 'Events'], function($, jqm, Backbone, _, Marionette, Meshable, Events) {
    var displayResults, node, nodeCompView, nodeView, nodes;

    node = Backbone.Model.extend({
      initialize: function() {
        return this.set({
          trafficlight: "green"
        });
      },
      defaults: {
        trafficlight: "green"
      }
    });
    nodes = Backbone.Collection.extend({
      model: node
    });
    nodeView = Backbone.Marionette.ItemView.extend({
      initialize: function(node) {
        this.bindTo(this.model, "change", this.render);
        return this.template = "#template-" + node.model.attributes.nodetemplate;
      },
      tagName: 'li',
      events: {
        "click .setstatic": "setbutton"
      },
      setbutton: function(e) {
        var channel, full_name, localobj, mistData, node_type, value;

        $.mobile.showPageLoadingMsg();
        value = $(e.target).parent().data('setvalue');
        node_type = $(e.target).parent().data('nodetype');
        channel = $(e.target).parent().data('channel');
        full_name = node_type + "." + channel;
        mistData = new Array;
        localobj = {
          ChannelId: this.model.attributes.channels[full_name].ChannelId,
          value: value,
          techName: this.model.attributes.channels[full_name].techName,
          name: full_name
        };
        mistData[0] = localobj;
        return this.setChannel(mistData);
      },
      setChannel: function(channels) {
        var mac,
          _this = this;

        mac = new Array;
        mac[0] = Meshable.currentMac;
        return window.forge.ajax({
          url: Meshable.rooturl + "/api/channel",
          data: JSON.stringify({
            macaddresses: [Meshable.currentMac],
            channelDTO: channels
          }),
          dataType: "json",
          type: "POST",
          contentType: 'application/json; charset=utf-8',
          error: function(e) {
            return $.mobile.hidePageLoadingMsg();
          },
          success: function(data) {
            return $.mobile.hidePageLoadingMsg();
          }
        });
      }
    });
    nodeCompView = Backbone.Marionette.CompositeView.extend({
      itemView: nodeView,
      template: "#wrapper_dashboard",
      itemViewContainer: "ul",
      id: "node",
      appendHtml: function(collectionView, itemView) {
        return collectionView.$("#dashboard_insert").append(itemView.el);
      }
    });
    Meshable.vent.on("goto:node", function(model) {
      return displayResults(model);
    });
    return displayResults = function(data) {
      var nodeCoView, nodeCollection, tempNode;

      nodeCollection = new nodes;
      tempNode = new node;
      nodeCollection.add(tempNode.parse(data));
      nodeCoView = new nodeCompView({
        collection: nodeCollection
      });
      Meshable.currentpage = "node";
      nodeCoView.render();
      $('#node').empty();
      $('#node').append($(nodeCoView.el));
      return Meshable.changePage(nodeCoView, false);
    };
  });

}).call(this);
