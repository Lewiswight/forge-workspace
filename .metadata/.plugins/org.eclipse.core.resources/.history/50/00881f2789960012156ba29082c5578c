define ['jquery', 'jqm', 'backbone','underscore','marionette', 'Meshable', 'Events'], ($, jqm, Backbone, _, Marionette, Meshable, Events) ->									 
	
	
				
				
				
		
			
	
	node = Backbone.Model.extend 
		initialize: -> 
				@set
					trafficlight: "green"		
			defaults: 				 				
				trafficlight: "green" 			
				
		
	nodes = Backbone.Collection.extend 
		model: node	
	


	nodeView = Backbone.Marionette.ItemView.extend
		initialize: (node) ->
			
			@bindTo @model, "change", @render
			@template = "#template-" + node.model.attributes.nodetemplate
			
			
		#template: '#node-template'
		tagName: 'li'
		
			
		events:
			#"click #mistBtn": "mist"
			#"click #stopBtn": "stop"
			"click .setstatic": "setbutton"
			
		
		setbutton: (e) ->
			$.mobile.showPageLoadingMsg()
			value = $(e.target).parent().data 'setvalue'		
			node_type = $(e.target).parent().data 'nodetype'
			channel = $(e.target).parent().data 'channel'
			full_name = node_type + "." + channel
			mistData = new Array
			localobj = 
				ChannelId: @model.attributes.channels[full_name].ChannelId
				value: value
				techName: @model.attributes.channels[full_name].techName
				name: full_name
			mistData[0] = localobj
			@setChannel mistData
			
			
		
		mist : ->
			$.mobile.showPageLoadingMsg()
			mistData = new Array
			localobj = 
				ChannelId: @model.attributes.channels["mc3.r"].ChannelId
				value: "M"
				techName: @model.attributes.channels["mc3.r"].techName
				name: "r"
			mistData[0] = localobj	
			@setChannel mistData
		
		stop : ->
			$.mobile.showPageLoadingMsg()
			stopData = new Array
			localobj = 
				ChannelId: @model.attributes.channels["mc3.r"].ChannelId
				value: "S"
				techName: @model.attributes.channels["mc3.r"].techName
				name: "r"
			stopData[0] = localobj	
			@setChannel stopData
		
		
		setChannel: (channels) -> 
			mac = new Array
			mac[0] = Meshable.currentMac
			#add validation
			#find the channels that need to be set 

			window.forge.ajax
				url: Meshable.rooturl + "/api/channel"
				data:  JSON.stringify({macaddresses: [Meshable.currentMac], channelDTO: channels})
				dataType: "json"
				type: "POST"
				contentType: 'application/json; charset=utf-8'
				error: (e) -> 
					$.mobile.hidePageLoadingMsg()
					#alert "An error occurred while getting node details... sorry!"
				success: (data) =>
					$.mobile.hidePageLoadingMsg()


	nodeCompView = Backbone.Marionette.CompositeView.extend
		itemView: nodeView
		template: "#wrapper_dashboard"
		itemViewContainer: "ul"
		id: "node"
		
		
		
		
			
		
		appendHtml: (collectionView, itemView) ->
			collectionView.$("#dashboard_insert").append(itemView.el) 

	
	
	Meshable.vent.on "goto:node", (model) ->
		
					
		displayResults model
		
		
	

	
	
					
	displayResults = (data) ->
		
		# check here to see if we are a mc3, mc3z, mc13, or mc13z
		
		nodeCollection = new nodes

		tempNode = new node
		nodeCollection.add tempNode.parse(data)
		nodeCoView = new nodeCompView
			collection: nodeCollection
	
		
		


			
		Meshable.currentpage = "node"
		#$.mobile.changePage $('#splash'), changeHash: false,  transition: 'none', showLoadMsg: false  
		Meshable.loginRegion.close()
		Meshable.mainRegion.close()
	
		Meshable.mainRegion.show(nodeCoView)

		#$("#gateway").attr "data-role", "listview"
		#$("#gateway").attr "data-insert", "true" 

	
		changePage nodeCoView, false
					
				
				
				
		
	changePage = (page, direction) ->
			$(page.el).attr "data-role", "page"
			$(page.el).attr "data-theme", Meshable.theme
			
		
			
			trans = "slide"
			
			if @firstPage
				trans = "none"
				@firstPage = false
			#$.mobile.loading "show",
			#	theme: 'e'
			$.mobile.changePage $(page.el), changeHash: true, reverse: direction, transition: "none"
		
			
	