// Generated by CoffeeScript 1.6.2
(function() {
  define(['jquery', 'jqm', 'backbone', 'underscore', 'marionette', 'Meshable', 'Events'], function($, jqm, Backbone, _, Marionette, Meshable, Events) {
    var form, formCompView, formView, formWrap;

    form = Backbone.Model.extend({
      initialize: function() {
        return this.set({
          trafficlight: "green"
        });
      },
      defaults: {
        trafficlight: "green"
      }
    });
    formWrap = Backbone.Collection.extend({
      model: form
    });
    formView = Backbone.Marionette.ItemView.extend({
      initialize: function(node) {
        return this.bindTo(this.model, "change", this.render);
      },
      template: '#template-contact',
      onRender: function() {
        $('#formName').val(Meshable.user.FirstName + " " + Meshable.user.LastName);
        $('#formEmail').val(Meshable.user.Email);
        $('#formPhone').val(Meshable.user.Phone);
        return $("#mistawayDiv").trigger('create');
      },
      events: {
        "click #formSubmit": "submit"
      },
      submit: function() {
        return forge.request.ajax({
          url: "https://sendgrid.com/api/mail.send.json",
          type: "GET",
          dataType: "json",
          timeout: "10000",
          contentType: 'application/json; charset=utf-8',
          data: {
            "api_user": "dane@houselynx.com",
            "api_key": "Z!gBMeshify",
            "to": Meshable.company.email,
            "toname": Meshable.company.name,
            "subject": $("#formName").val() + " has sent you a message from the iMistAway Mobile App",
            "text": "Customer: " + $("#formName").val() + " \n" + "Phone: " + $("#formPhone").val() + "\n" + "Email: " + $("#formEmail").val() + "\n \n Needs help with: " + $("#formReason").val() + "\n \n And has included the following message: \n\n" + $("#formMessage").val(),
            "from": $("#formEmail").val()
          },
          error: function(e) {
            $("body").removeClass('ui-disabled');
            $.mobile.hidePageLoadingMsg();
            forge.notification.alert("Error", e.message);
            return Meshable.router.navigate("", {
              trigger: true
            });
          },
          success: function(data) {
            return forge.notification.alert("Message Sent", "Your authorized dealer will be contacting you shortly about your request");
          }
        });
      }
    });
    formCompView = Backbone.Marionette.CompositeView.extend({
      itemView: formView,
      template: "#wrapper_ul",
      itemViewContainer: "ul",
      appendHtml: function(collectionView, itemView) {
        return collectionView.$("#placeholder").append(itemView.el);
      }
    });
    return Meshable.vent.on("goto:contact", function() {
      var compView, form_collection;

      Meshable.contactButton.setActive();
      form_collection = new formWrap([
        new form({
          name: Meshable.company.name,
          zip: Meshable.company.zip,
          city: Meshable.company.city,
          state: Meshable.company.state,
          street: Meshable.company.street,
          email: Meshable.company.email,
          phone: Meshable.company.phone,
          image: Meshable.company.image
        })
      ]);
      compView = new formCompView({
        collection: form_collection
      });
      Meshable.currentpage = "contact";
      compView.render();
      $('#mainDiv').empty();
      $('#mainDiv').append($(compView.el));
      $("#mainDiv").trigger('create');
      $.mobile.hidePageLoadingMsg();
      $("body").removeClass('ui-disabled');
      $('#formName').val(Meshable.user.FirstName + " " + Meshable.user.LastName);
      $('#formEmail').val(Meshable.user.Email);
      $('#formPhone').val(Meshable.user.Phone);
      return $("#mistawayDiv").trigger('create');
    });
  });

}).call(this);
